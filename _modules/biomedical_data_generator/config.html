

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>biomedical_data_generator.config &mdash; Biomedical Data Generator 0.1.5rc2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=7f485136" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=fa69bd61"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Biomedical Data Generator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../code-doc.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sigrun-may/biomedical-data-generator/blob/main/LICENSE">License</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/sigrun-may/biomedical-data-generator">GitHub Repository</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/biomedical_data_generator.generate_dataset.html">biomedical_data_generator.generate_dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/biomedical_data_generator.find_seed_for_correlation.html">biomedical_data_generator.find_seed_for_correlation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/biomedical_data_generator.DatasetConfig.html">biomedical_data_generator.DatasetConfig</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Biomedical Data Generator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">biomedical_data_generator.config</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for biomedical_data_generator.config</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2025 Sigrun May,</span>
<span class="c1"># Ostfalia Hochschule für angewandte Wissenschaften</span>
<span class="c1">#</span>
<span class="c1"># This software is distributed under the terms of the MIT license</span>
<span class="c1"># which is available at https://opensource.org/licenses/MIT</span>

<span class="sd">&quot;&quot;&quot;Configuration models for the dataset generator.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">TypeAlias</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">ConfigDict</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">field_validator</span><span class="p">,</span> <span class="n">model_validator</span>

<span class="n">AnchorMode</span><span class="p">:</span> <span class="n">TypeAlias</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;equalized&quot;</span><span class="p">,</span> <span class="s2">&quot;strong&quot;</span><span class="p">]</span>
<span class="n">DistributionType</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
    <span class="s2">&quot;normal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lognormal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exp_normal&quot;</span><span class="p">,</span>  <span class="c1"># np.exp(rng.normal()) - direct control over underlying parameters for lognormal distribution</span>
    <span class="s2">&quot;uniform&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exponential&quot;</span><span class="p">,</span>
    <span class="s2">&quot;laplace&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Shared helpers</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<span class="k">def</span><span class="w"> </span><span class="nf">validate_distribution_params</span><span class="p">(</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">distribution</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Shared validator for distribution parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        params: Parameter dict to validate.</span>
<span class="sd">        distribution: Distribution type (e.g., &quot;normal&quot;, &quot;uniform&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Validated parameter dict.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If parameters are invalid for the given distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="n">param_schema</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;normal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">}},</span>
        <span class="s2">&quot;uniform&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">},</span> <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">()},</span>
        <span class="s2">&quot;laplace&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">}},</span>
        <span class="s2">&quot;exponential&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;scale&quot;</span><span class="p">}},</span>
        <span class="s2">&quot;lognormal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">}},</span>
        <span class="s2">&quot;exp_normal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span> <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">}},</span>
    <span class="p">}</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="n">param_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">distribution</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">schema</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">params</span>

    <span class="n">provided</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">invalid</span> <span class="o">=</span> <span class="n">provided</span> <span class="o">-</span> <span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;optional&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">invalid</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid parameters </span><span class="si">{</span><span class="n">invalid</span><span class="si">}</span><span class="s2"> for &#39;</span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&#39;. &quot;</span> <span class="sa">f</span><span class="s2">&quot;Allowed: </span><span class="si">{</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;required&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;optional&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">missing</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">provided</span>
    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required parameters </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2"> for &#39;</span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Distribution-specific checks</span>
    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">low</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">])</span>
            <span class="n">high</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;uniform parameters must be numeric, got low=</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, high=</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">low</span> <span class="o">&lt;</span> <span class="n">high</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;uniform: &#39;high&#39; (</span><span class="si">{</span><span class="n">high</span><span class="si">}</span><span class="s2">) must be &gt; &#39;low&#39; (</span><span class="si">{</span><span class="n">low</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="c1"># Scale parameters must be positive (normal, laplace, exponential, exp_normal)</span>
    <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scale_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;scale&#39; must be numeric, got </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">if</span> <span class="n">scale_val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;scale&#39; must be &gt; 0, got </span><span class="si">{</span><span class="n">scale_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Sigma must be positive (lognormal)</span>
    <span class="k">if</span> <span class="s2">&quot;sigma&quot;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sigma_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;sigma&#39; must be numeric, got </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">if</span> <span class="n">sigma_val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;sigma&#39; must be &gt; 0, got </span><span class="si">{</span><span class="n">sigma_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># loc and mean must be numeric if present</span>
    <span class="k">for</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;loc&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">])</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">param_name</span><span class="si">}</span><span class="s2">&#39; must be numeric, got </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">return</span> <span class="n">params</span>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Class configuration</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ClassConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for a single class in the dataset.</span>

<span class="sd">    Each class is defined by its sample count, distribution, and optional label.</span>
<span class="sd">    Class labels (0, 1, 2, ...) are assigned by position in the list.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_samples: Number of samples for this class (must be &gt;= 1).</span>
<span class="sd">        class_distribution: Distribution type for feature generation.</span>
<span class="sd">        class_distribution_params: Parameters for the chosen distribution.</span>
<span class="sd">        label: Optional descriptive name. Auto-generated as &quot;class_0&quot;, &quot;class_1&quot;, etc. if not provided.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; # Auto-generated labels</span>
<span class="sd">        &gt;&gt;&gt; configs = [</span>
<span class="sd">        ...     ClassConfig(n_samples=100),  # label → &quot;class_0&quot;</span>
<span class="sd">        ...     ClassConfig(n_samples=50)    # label → &quot;class_1&quot;</span>
<span class="sd">        ... ]</span>

<span class="sd">        &gt;&gt;&gt; # Explicit semantic labels</span>
<span class="sd">        &gt;&gt;&gt; configs = [</span>
<span class="sd">        ...     ClassConfig(n_samples=100, label=&quot;healthy&quot;),</span>
<span class="sd">        ...     ClassConfig(n_samples=50, label=&quot;diseased&quot;)</span>
<span class="sd">        ... ]</span>

<span class="sd">        &gt;&gt;&gt; # Different distributions per class</span>
<span class="sd">        &gt;&gt;&gt; configs = [</span>
<span class="sd">        ...     ClassConfig(n_samples=50, label=&quot;control&quot;, class_distribution=&quot;normal&quot;),</span>
<span class="sd">        ...     ClassConfig(</span>
<span class="sd">        ...         n_samples=30,</span>
<span class="sd">        ...         label=&quot;diseased&quot;,</span>
<span class="sd">        ...         class_distribution=&quot;lognormal&quot;,</span>
<span class="sd">        ...         class_distribution_params={&quot;mean&quot;: 0, &quot;sigma&quot;: 0.5}</span>
<span class="sd">        ...     )</span>
<span class="sd">        ... ]</span>

<span class="sd">    Notes:</span>
<span class="sd">        - Class index is determined by position: first config = class 0, etc.</span>
<span class="sd">        - n_samples is exact (not a weight or proportion)</span>
<span class="sd">        - label is auto-generated if None or empty string</span>
<span class="sd">        - Auto-generated labels follow pattern &quot;class_{idx}&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">)</span>

    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of samples in this class.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">class_distribution</span><span class="p">:</span> <span class="n">DistributionType</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Distribution type for base feature generation.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">class_distribution_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Distribution parameters.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Label (auto-generated as &#39;class_</span><span class="si">{idx}</span><span class="s2">&#39; if None).&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;class_distribution_params&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_class_params</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate distribution parameters match the chosen distribution.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class_distribution&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">validate_distribution_params</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">distribution</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Concise string representation.&quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;n=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;label=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_distribution</span> <span class="o">!=</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dist=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">class_distribution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;ClassConfig(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BatchEffectsConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for simulating batch effects.</span>

<span class="sd">    Simulate batch effects by adding random intercepts or scaling factors</span>
<span class="sd">    to specified features. This can be used to mimic:</span>
<span class="sd">      - site-to-site differences (multi-center studies),</span>
<span class="sd">      - instrument calibration shifts,</span>
<span class="sd">      - cohort / recruitment waves (temporal batches).</span>

<span class="sd">    Randomness and reproducibility</span>
<span class="sd">    ------------------------------</span>
<span class="sd">    Batch effects are integrated into the dataset-level RNG in a predictable way:</span>

<span class="sd">    - In :func:`generate_dataset`, a single</span>
<span class="sd">      ``rng_global = np.random.default_rng(cfg.random_state)`` is created.</span>

<span class="sd">    - If ``BatchEffectsConfig.random_state`` is ``None`` (recommended),</span>
<span class="sd">      **all batch-related draws reuse this global generator**:</span>
<span class="sd">        * batch assignment (random or confounded),</span>
<span class="sd">        * batch effects (additive or multiplicative).</span>
<span class="sd">      In this default mode, ``DatasetConfig.random_state`` is the **single knob**</span>
<span class="sd">      that reproduces the entire dataset, *including* batch effects.</span>

<span class="sd">    - If ``BatchEffectsConfig.random_state`` is an integer, a dedicated RNG</span>
<span class="sd">      ``np.random.default_rng(batch.random_state)`` is created and passed to the</span>
<span class="sd">      batch-effect routines. Use this only if you explicitly want to keep batch</span>
<span class="sd">      effects fixed while changing other aspects of the dataset.</span>

<span class="sd">    Conceptual separation</span>
<span class="sd">    ---------------------</span>
<span class="sd">    - ``confounding_with_class`` controls **sampling bias**:</span>
<span class="sd">      which samples (classes) are recruited into which batch.</span>

<span class="sd">    - ``effect_strength`` and ``effect_type`` control **technical variation**:</span>
<span class="sd">      how strongly the measurement shifts between batches.</span>

<span class="sd">    Args:</span>
<span class="sd">        n_batches:</span>
<span class="sd">            Number of batches. Values 0 or 1 effectively disable batch effects.</span>
<span class="sd">        effect_strength:</span>
<span class="sd">            Scale of batch effects.</span>
<span class="sd">            - For ``effect_type=&quot;additive&quot;``: standard deviation of batch intercepts.</span>
<span class="sd">            - For ``effect_type=&quot;multipliclicative&quot;``: standard deviation of the</span>
<span class="sd">              multiplicative factor (applied as ``X&#39; = X * (1 + b_batch)``).</span>
<span class="sd">        effect_type:</span>
<span class="sd">            Type of batch effect.</span>
<span class="sd">            - ``&quot;additive&quot;``: Additive intercepts (shifts in feature means).</span>
<span class="sd">            - ``&quot;multiplicative&quot;``: Multiplicative scaling (changes in variance/scale).</span>
<span class="sd">        confounding_with_class: Degree of confounding between batch and class (0.0-1.0).</span>
<span class="sd">            Controls how strongly batch assignment correlates with class labels,</span>
<span class="sd">            simulating **recruitment bias** in multi-center studies.</span>

<span class="sd">            The parameter determines the probability that samples from the same</span>
<span class="sd">            class are assigned to the same batch:</span>
<span class="sd">            Semantics (for two classes / two batches, equal base proportions):</span>
<span class="sd">                - 0.0 → independent: each batch has ~50/50 class mix.</span>
<span class="sd">                - 0.5 → moderate correlation</span>
<span class="sd">                - 0.8 → strong recruitment bias (most samples of a class go to one batch).</span>
<span class="sd">                - 1.0 → perfect confounding: each class maps to one preferred batch</span>
<span class="sd">                  (if ``n_batches &gt;= n_classes``).</span>
<span class="sd">        affected_features (list[int] | Literal[&quot;all&quot;, &quot;informative&quot;]):</span>
<span class="sd">            Which features should be affected:</span>
<span class="sd">            - ``&quot;all&quot;``: apply batch effects to all features.</span>
<span class="sd">            - ``&quot;informative&quot;``: apply only to informative features.</span>
<span class="sd">            - list of ints: explicit 0-based column indices.</span>
<span class="sd">        proportions:</span>
<span class="sd">            Optional target proportions for batch sizes. Values are normalized</span>
<span class="sd">            to sum to 1. If ``None``, batches are (approximately) equal in size.</span>
<span class="sd">        random_state:</span>
<span class="sd">            Optional seed specific to batch effects. ``None`` → reuse dataset RNG.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">)</span>

    <span class="n">n_batches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 0 or 1 =&gt; no batch effect</span>
    <span class="n">effect_strength</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># std of batch effects</span>
    <span class="n">effect_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;additive&quot;</span><span class="p">,</span> <span class="s2">&quot;multiplicative&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;additive&quot;</span>
    <span class="n">confounding_with_class</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># in [0,1]</span>
    <span class="n">affected_features</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;informative&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>  <span class="c1"># 0-based column indices; &quot;all&quot; =&gt; all</span>
    <span class="n">proportions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># optional batch proportions</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;proportions&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_proportions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure proportions are non-negative, match n_batches, and sum to 1.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;proportions must not be empty if provided.&quot;</span><span class="p">)</span>

        <span class="c1"># Non-negative entries</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;proportions must be non-negative, got </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Check length vs n_batches (if &gt; 0)</span>
        <span class="n">n_batches</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_batches&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_batches</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n_batches</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_batches</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;proportions length (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">) must match n_batches (</span><span class="si">{</span><span class="n">n_batches</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

        <span class="n">total</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sum of proportions must be &gt; 0, got </span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Normalize to sum to 1.0</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="o">/</span> <span class="n">total</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Correlated clusters</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CorrClusterConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Correlated feature cluster simulating coordinated biomarker patterns.</span>

<span class="sd">    A cluster represents a group of biomarkers that move together, such as</span>
<span class="sd">    markers in a metabolic pathway or proteins in a signaling cascade. One marker</span>
<span class="sd">    acts as the &quot;anchor&quot; (driver), while the others are &quot;proxies&quot; (followers).</span>

<span class="sd">    Args:</span>
<span class="sd">        n_cluster_features:</span>
<span class="sd">            Number of biomarkers in the cluster (including anchor). Must be &gt;= 1.</span>
<span class="sd">        rho:</span>
<span class="sd">            Correlation strength between biomarkers in the cluster:</span>
<span class="sd">              - 0.0 = independent</span>
<span class="sd">              - 0.5 = moderate correlation</span>
<span class="sd">              - 0.8+ = strong correlation</span>
<span class="sd">            For equicorrelated:</span>
<span class="sd">                - lower bound = -1 / (p-1) for p &gt; 1</span>
<span class="sd">                - upper bound &lt; 1</span>
<span class="sd">            For toeplitz:</span>
<span class="sd">                - |rho| &lt; 1</span>
<span class="sd">        structure:</span>
<span class="sd">            &quot;equicorrelated&quot; or &quot;toeplitz&quot;.</span>
<span class="sd">        class_structure:</span>
<span class="sd">            Per-class override for correlation structure.</span>
<span class="sd">        class_rho:</span>
<span class="sd">            Per-class override for correlation strength.</span>
<span class="sd">        rho_baseline:</span>
<span class="sd">            Fallback correlation for classes not in class_rho (default 0.0).</span>
<span class="sd">        anchor_role:</span>
<span class="sd">            &quot;informative&quot; or &quot;noise&quot;.</span>
<span class="sd">        anchor_effect_size:</span>
<span class="sd">            &quot;small&quot; (0.5), &quot;medium&quot; (1.0), &quot;large&quot; (1.5), custom &gt; 0, or None.</span>
<span class="sd">        anchor_class:</span>
<span class="sd">            Class index the anchor predicts (if informative). None → all classes.</span>
<span class="sd">        random_state:</span>
<span class="sd">            Optional seed for this cluster. If None, uses the global dataset seed.</span>
<span class="sd">        label:</span>
<span class="sd">            Descriptive name for documentation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">)</span>

    <span class="c1"># Core cluster structure and correlation settings</span>
    <span class="n">n_cluster_features</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="o">...</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of biomarkers in cluster (including anchor).&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">structure</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;equicorrelated&quot;</span><span class="p">,</span> <span class="s2">&quot;toeplitz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;equicorrelated&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Default correlation structure for all classes.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Default correlation strength for all classes.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Per-class correlation (optional)</span>
    <span class="n">class_structure</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;equicorrelated&quot;</span><span class="p">,</span> <span class="s2">&quot;toeplitz&quot;</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Per-class correlation structure (overrides &#39;structure&#39; for specified classes).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">class_rho</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Per-class correlation strength (activates class-specific mode).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">rho_baseline</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">ge</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">lt</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Fallback correlation for classes not in class_rho.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Biological relevance</span>
    <span class="n">anchor_role</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;informative&quot;</span><span class="p">,</span> <span class="s2">&quot;noise&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;informative&quot;</span>
    <span class="n">anchor_effect_size</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;small&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">anchor_class</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Metadata</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;n_cluster_features&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_size</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure cluster has at least one marker.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_cluster_features must be &gt;= 1, got </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;rho&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_rho_range</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_cluster_features&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="s2">&quot;equicorrelated&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">structure</span> <span class="o">==</span> <span class="s2">&quot;equicorrelated&quot;</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lower</span> <span class="o">&lt;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;rho=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> invalid for equicorrelated with n_cluster_features=</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;require </span><span class="si">{</span><span class="n">lower</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> &lt; rho &lt; 1.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># toeplitz</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;For toeplitz, require |rho| &lt; 1.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;class_rho&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_class_rho</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_cluster_features&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="s2">&quot;equicorrelated&quot;</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">structure</span> <span class="o">==</span> <span class="s2">&quot;equicorrelated&quot;</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">cls_idx</span><span class="p">,</span> <span class="n">rho_val</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cls_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class_rho keys must be &gt;= 0, got </span><span class="si">{</span><span class="n">cls_idx</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lower</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">rho_val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;class_rho[</span><span class="si">{</span><span class="n">cls_idx</span><span class="si">}</span><span class="s2">]=</span><span class="si">{</span><span class="n">rho_val</span><span class="si">}</span><span class="s2"> invalid for </span><span class="si">{</span><span class="n">structure</span><span class="si">}</span><span class="s2"> (p=</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">); &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;require </span><span class="si">{</span><span class="n">lower</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> &lt; rho &lt; 1.&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;rho_baseline&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_rho_baseline</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate rho_baseline against structure constraints.</span>

<span class="sd">        rho_baseline must satisfy the same positive-definiteness constraints</span>
<span class="sd">        as rho and class_rho, since it&#39;s used as a correlation parameter</span>
<span class="sd">        for classes not specified in class_rho.</span>

<span class="sd">        Args:</span>
<span class="sd">            v: The rho_baseline value to validate.</span>
<span class="sd">            info: Validation context with access to other fields.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The validated rho_baseline value.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If rho_baseline violates PD constraints for the structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_cluster_features&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">,</span> <span class="s2">&quot;equicorrelated&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">structure</span> <span class="o">==</span> <span class="s2">&quot;equicorrelated&quot;</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;-inf&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lower</span> <span class="o">&lt;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;rho_baseline=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> invalid for equicorrelated with &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;n_cluster_features=</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">; require </span><span class="si">{</span><span class="n">lower</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> &lt; rho_baseline &lt; 1.0&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># toeplitz</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rho_baseline=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> invalid for toeplitz; require |rho_baseline| &lt; 1.0&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;class_structure&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_class_structure</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate per-class structure keys.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="k">for</span> <span class="n">cls_idx</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cls_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class_structure keys must be &gt;= 0, got </span><span class="si">{</span><span class="n">cls_idx</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_class_specific_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure class_structure is only used with class_rho.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_rho</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;class_structure requires class_rho to be set. &quot;</span>
                <span class="s2">&quot;Either set class_rho (activates class-specific mode) or remove class_structure.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;anchor_effect_size&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_effect_size</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;small&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate effect size is either a preset or positive float.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="c1"># Preset string</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;small&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;anchor_effect_size must be &#39;small&#39;, &#39;medium&#39;, or &#39;large&#39;, &quot;</span> <span class="sa">f</span><span class="s2">&quot;got &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;small&quot;</span><span class="p">,</span> <span class="s2">&quot;medium&quot;</span><span class="p">,</span> <span class="s2">&quot;large&quot;</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># Custom float</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;anchor_effect_size must be &gt; 0, got </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;anchor_effect_size must be &#39;small&#39;/&#39;medium&#39;/&#39;large&#39; or positive float, &quot;</span> <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;anchor_class&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_anchor_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure disease class is non-negative if specified.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;anchor_class must be &gt;= 0 or None, got </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="c1"># Convenience methods -----------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_class_specific</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if this cluster uses class-specific correlation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_rho</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_rho_for_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get correlation strength for a specific class.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_class_specific</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_rho</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_rho</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho_baseline</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_structure_for_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;equicorrelated&quot;</span><span class="p">,</span> <span class="s2">&quot;toeplitz&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get correlation structure for a specific class.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_structure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">class_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_anchor_effect_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert anchor_effect_size to a numeric effect size.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_effect_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>  <span class="c1"># default to medium</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anchor_effect_size</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">effect_map</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;small&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">&quot;medium&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;large&quot;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">effect_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">anchor_effect_size</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anchor_effect_size</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return human-readable summary in medical terms.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Formatted summary of cluster configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Biomarker Cluster: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;Unnamed&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Cluster structure</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Cluster Structure:&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  Number of markers: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cluster_features</span><span class="si">}</span><span class="s2"> (1 anchor + </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cluster_features</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> proxies)&quot;</span>
        <span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Correlation strength: rho=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="c1"># Interpret correlation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">corr_desc</span> <span class="o">=</span> <span class="s2">&quot;weak/independent&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">:</span>
            <span class="n">corr_desc</span> <span class="o">=</span> <span class="s2">&quot;moderate&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
            <span class="n">corr_desc</span> <span class="o">=</span> <span class="s2">&quot;strong&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">corr_desc</span> <span class="o">=</span> <span class="s2">&quot;very strong (pathway-like)&quot;</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Interpretation: </span><span class="si">{</span><span class="n">corr_desc</span><span class="si">}</span><span class="s2"> biological coupling&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Anchor properties</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Anchor Marker:&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Role: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anchor_role</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_role</span> <span class="o">==</span> <span class="s2">&quot;informative&quot;</span><span class="p">:</span>
            <span class="n">effect_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_anchor_effect_size</span><span class="p">()</span>
            <span class="n">effect_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_effect_size</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_effect_size</span> <span class="k">else</span> <span class="s2">&quot;medium&quot;</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Effect size: </span><span class="si">{</span><span class="n">effect_str</span><span class="si">}</span><span class="s2"> (value=</span><span class="si">{</span><span class="n">effect_value</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Predicts: class </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anchor_class</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Medical interpretation of effect size</span>
            <span class="k">if</span> <span class="n">effect_value</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  → Subtle signal (large sample needed)&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">effect_value</span> <span class="o">&lt;</span> <span class="mf">1.2</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  → Moderate signal (typical biomarker)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  → Strong signal (easy to detect)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  → Random noise (no signal)&quot;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random seed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;from dataset&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_rho</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Baseline rho for other classes: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rho_baseline</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Per-class overrides:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_rho</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_structure</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_structure</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  class </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: rho=</span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Concise representation for quick reference.&quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;n_cluster_features=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cluster_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;rho=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_role</span> <span class="o">!=</span> <span class="s2">&quot;informative&quot;</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anchor_role</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_effect_size</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;effect=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">anchor_effect_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;CorrCluster(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>


<span class="c1"># ---------------------------------------------------------------------------</span>
<span class="c1"># Dataset configuration</span>
<span class="c1"># ---------------------------------------------------------------------------</span>


<div class="viewcode-block" id="DatasetConfig">
<a class="viewcode-back" href="../../_autosummary/biomedical_data_generator.DatasetConfig.html#biomedical_data_generator.DatasetConfig">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DatasetConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for synthetic dataset generation.</span>

<span class="sd">    Overview</span>
<span class="sd">    --------</span>
<span class="sd">    This model defines the *input-level* controls for building a synthetic dataset.</span>
<span class="sd">    It combines:</span>
<span class="sd">      - Base role counts: `n_informative` and `n_noise`</span>
<span class="sd">      - Correlated clusters: `corr_clusters` (each 1 anchor + (k−1) proxies)</span>
<span class="sd">      - Class definitions: `class_configs` (with per-class n_samples and labels)</span>
<span class="sd">      - Optional batch effects</span>

<span class="sd">    Derived quantities</span>
<span class="sd">    ------------------</span>
<span class="sd">    These attributes are **derived** and must not be passed by the user:</span>

<span class="sd">    - ``n_samples``  = sum(c.n_samples for c in class_configs)</span>
<span class="sd">    - ``n_classes``  = len(class_configs)</span>
<span class="sd">    - ``n_features`` = n_informative + n_noise + proxies_from_clusters</span>

<span class="sd">      where</span>

<span class="sd">        proxies_from_clusters = sum(max(0, k - 1) for each CorrClusterConfig</span>
<span class="sd">                                    with n_cluster_features = k)</span>

<span class="sd">    Labels</span>
<span class="sd">    ------</span>
<span class="sd">    - If a ClassConfig label is None or &quot;&quot;, it is auto-filled as &quot;class_{idx}&quot;.</span>
<span class="sd">    - `class_labels` returns the list of resolved labels.</span>

<span class="sd">    Validation &amp; normalization</span>
<span class="sd">    --------------------------</span>
<span class="sd">    - A `mode=&quot;before&quot;` validator:</span>
<span class="sd">        * forbids manual `n_samples`, `n_classes`, `n_features`</span>
<span class="sd">        * normalizes `class_sep`:</span>
<span class="sd">             - scalar → broadcast to length `n_classes - 1`</span>
<span class="sd">             - sequence → checked for numeric entries and length `n_classes - 1`</span>
<span class="sd">    - A `mode=&quot;after&quot;` validator:</span>
<span class="sd">        * checks:</span>
<span class="sd">             - `n_informative &gt;= #informative_anchors`</span>
<span class="sd">             - `n_noise       &gt;= #noise_anchors`</span>
<span class="sd">             - `corr_between` in [-1, 1]</span>
<span class="sd">             - `anchor_class` indices are &lt; `n_classes`</span>

<span class="sd">    Naming policy</span>
<span class="sd">    -------------</span>
<span class="sd">    - If `feature_naming=&quot;prefixed&quot;`:</span>
<span class="sd">        * Free informative:  i1, i2, ...</span>
<span class="sd">        * Free noise:        n1, n2, ...</span>
<span class="sd">        * Correlated:        corr{cid}_anchor, corr{cid}_2, ..., corr{cid}_k</span>
<span class="sd">    - If `feature_naming=&quot;simple&quot;`, a generic `feature_{i}` scheme is used.</span>


<span class="sd">    Examples (counting)</span>
<span class="sd">    -------------------</span>
<span class="sd">    1) One cluster k=4 with an informative anchor, plus n_informative=3, n_noise=2</span>
<span class="sd">       proxies_from_clusters = (4−1) = 3</span>
<span class="sd">       n_features_expected   = 3 + 2 + 3 = 8</span>
<span class="sd">       Breakdown:</span>
<span class="sd">         - informative_anchors = 1  → free_informative = 3 − 1 = 2</span>
<span class="sd">         - noise_anchors = 0        → free_noise       = 2 − 0 = 2</span>

<span class="sd">    2) Two clusters: k=5 (informative anchor), k=3 (&quot;noise&quot; anchor), base n_informative=4, n_noise=3</span>
<span class="sd">       proxies_from_clusters = (5−1) + (3−1) = 6</span>
<span class="sd">       n_features_expected   = 4 + 3 + 6 = 13</span>
<span class="sd">       Breakdown:</span>
<span class="sd">         - informative_anchors = 1  → free_informative = 4 − 1 = 3</span>
<span class="sd">         - noise_anchors = 1        → free_noise       = 3 − 1 = 2</span>

<span class="sd">    Example usage:</span>
<span class="sd">    --------------</span>
<span class="sd">        &gt;&gt;&gt; cfg = DatasetConfig(</span>
<span class="sd">        ...     n_informative=5,</span>
<span class="sd">        ...     n_noise=3,</span>
<span class="sd">        ...     class_configs=[</span>
<span class="sd">        ...         ClassConfig(n_samples=50, label=&quot;healthy&quot;),</span>
<span class="sd">        ...         ClassConfig(n_samples=50, label=&quot;diseased&quot;),</span>
<span class="sd">        ...     ],</span>
<span class="sd">        ...     corr_clusters=[</span>
<span class="sd">        ...         CorrClusterConfig(</span>
<span class="sd">        ...             n_cluster_features=4,</span>
<span class="sd">        ...             rho=0.8,</span>
<span class="sd">        ...             anchor_role=&quot;informative&quot;,</span>
<span class="sd">        ...             anchor_effect_size=&quot;medium&quot;,</span>
<span class="sd">        ...             anchor_class=1,</span>
<span class="sd">        ...             label=&quot;Metabolic Pathway A&quot;</span>
<span class="sd">        ...         ),</span>
<span class="sd">        ...         CorrClusterConfig(</span>
<span class="sd">        ...             n_cluster_features=3,</span>
<span class="sd">        ...             rho=0.5,</span>
<span class="sd">        ...             anchor_role=&quot;noise&quot;,</span>
<span class="sd">        ...             label=&quot;Random Noise Cluster&quot;</span>
<span class="sd">        ...         )</span>
<span class="sd">        ...     ],</span>
<span class="sd">        ...     corr_between=0.1,</span>
<span class="sd">        ...     noise_distribution=&quot;normal&quot;,</span>
<span class="sd">        ...     noise_distribution_params={&quot;loc&quot;: 0, &quot;scale&quot;: 1},</span>
<span class="sd">        ...     feature_naming=&quot;prefixed&quot;,</span>
<span class="sd">        ...     random_state=42</span>
<span class="sd">        ... )</span>

<span class="sd">    See Also:</span>
<span class="sd">    --------</span>
<span class="sd">    CorrClusterConfig  : Correlated cluster settings (size, rho, anchor role/effect/class)</span>
<span class="sd">    DatasetMeta        : Output ground-truth meta (indices for anchors, proxies, cluster layout)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="s2">&quot;forbid&quot;</span><span class="p">,</span> <span class="n">use_enum_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Core dataset structure</span>
    <span class="n">n_informative</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">n_noise</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Multi-class controls</span>
    <span class="n">class_configs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ClassConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="p">[</span><span class="n">ClassConfig</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;healthy&quot;</span><span class="p">),</span> <span class="n">ClassConfig</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;diseased&quot;</span><span class="p">)],</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="n">class_sep</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">],</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Class separation values (normalized to length n_classes - 1).&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Noise distribution (NumPy Generator API)</span>
    <span class="n">noise_distribution</span><span class="p">:</span> <span class="n">DistributionType</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span>
    <span class="n">noise_distribution_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

    <span class="c1"># Naming</span>
    <span class="n">feature_naming</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;prefixed&quot;</span><span class="p">,</span> <span class="s2">&quot;simple&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;prefixed&quot;</span>
    <span class="n">prefix_informative</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;i&quot;</span>
    <span class="n">prefix_noise</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;n&quot;</span>
    <span class="n">prefix_corr</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;corr&quot;</span>

    <span class="c1"># Correlated structure</span>
    <span class="n">corr_clusters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CorrClusterConfig</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">corr_between</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># correlation between different clusters/roles (0 = independent)</span>

    <span class="c1"># Batch effects</span>
    <span class="n">batch</span><span class="p">:</span> <span class="n">BatchEffectsConfig</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Global seed</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># ------------------------------------------------------------------ helpers</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_iter_cluster_dicts</span><span class="p">(</span>
        <span class="n">raw_config</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield cluster dicts from raw_config, regardless of item type.</span>

<span class="sd">        This helper is kept for potential external use (e.g., pre-inspection of</span>
<span class="sd">        raw YAML configs). It is not used in the main validation path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clusters</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">raw_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;corr_clusters&quot;</span><span class="p">)</span>  <span class="c1"># list[dict] / list[CorrClusterConfig] / None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">out</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">CorrClusterConfig</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s2">&quot;corr_clusters entries must be Mapping or CorrClusterConfig, &quot;</span> <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_sep_value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_separation</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate a single class separation value (numeric &amp; finite).&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">class_separation</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class_sep entries must be numeric, got </span><span class="si">{</span><span class="n">class_separation</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">fv</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class_sep entries must be finite numbers, got </span><span class="si">{</span><span class="n">class_separation</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fv</span>

    <span class="c1"># ------------------------------------------------------ before validator</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_and_validate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize incoming data BEFORE model construction.</span>

<span class="sd">        - Forbids manual `n_samples`, `n_classes`, `n_features`.</span>
<span class="sd">        - Normalizes `class_sep` to a list of length `n_classes - 1`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DatasetConfig expects a mapping-like raw_config, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Forbid manual override of derived attributes</span>
        <span class="k">for</span> <span class="n">forbidden</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;n_samples&quot;</span><span class="p">,</span> <span class="s2">&quot;n_classes&quot;</span><span class="p">,</span> <span class="s2">&quot;n_features&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">forbidden</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">forbidden</span><span class="si">}</span><span class="s2"> is derived from class_configs/corr_clusters and &quot;</span>
                    <span class="s2">&quot;must not be set manually on DatasetConfig.&quot;</span>
                <span class="p">)</span>

        <span class="n">classes</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class_configs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;class_configs must be a non-string sequence of class definitions.&quot;</span><span class="p">)</span>

        <span class="n">n_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_classes</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;At least two classes are required, got </span><span class="si">{</span><span class="n">n_classes</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Normalize class_sep:</span>
        <span class="c1"># - scalar → broadcast</span>
        <span class="c1"># - sequence → validate entries and length</span>
        <span class="n">raw_sep</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;class_sep&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_sep</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">sep_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_validate_sep_value</span><span class="p">(</span><span class="n">raw_sep</span><span class="p">)]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_classes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_sep</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_sep</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">sep_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_validate_sep_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">raw_sep</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class_sep must be a number or sequence, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">raw_sep</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sep_list</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_classes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class_sep length must be n_classes - 1 (</span><span class="si">{</span><span class="n">n_classes</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">), &quot;</span> <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sep_list</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;class_sep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sep_list</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="c1"># ------------------------------------------------------ field validation</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;noise_distribution_params&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_noise_params</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate distribution parameters match the chosen noise distribution.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;noise_distribution&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">validate_distribution_params</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">distribution</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------ after validators</span>
    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_enforce_minimum_informative</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure n_informative &gt;= number of informative anchors.&quot;&quot;&quot;</span>
        <span class="n">required</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_informative_anchors</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_informative</span> <span class="o">&lt;</span> <span class="n">required</span><span class="p">:</span>
            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_informative</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;n_informative&quot;</span><span class="p">,</span> <span class="n">required</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[DatasetConfig] n_informative was increased from </span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">required</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;because your correlated clusters define </span><span class="si">{</span><span class="n">required</span><span class="si">}</span><span class="s2"> informative anchors.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_auto_generate_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auto-generate labels as &#39;class_{idx}&#39; if not provided.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cls_cfg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_configs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cls_cfg</span><span class="o">.</span><span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cls_cfg</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="c1"># ClassConfig is a BaseModel, so we need object.__setattr__</span>
                <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">cls_cfg</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;class_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sanity checks tying together anchors, counts, and classes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_noise</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n_noise must be &gt;= 0.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_informative</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n_informative must be &gt;= 0.&quot;</span><span class="p">)</span>

        <span class="n">inf_anchors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_informative_anchors</span><span class="p">()</span>
        <span class="n">noise_anchors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_noise_anchors</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_informative</span> <span class="o">&lt;</span> <span class="n">inf_anchors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_informative (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_informative</span><span class="si">}</span><span class="s2">) &lt; number of informative anchors (</span><span class="si">{</span><span class="n">inf_anchors</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_noise</span> <span class="o">&lt;</span> <span class="n">noise_anchors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n_noise (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_noise</span><span class="si">}</span><span class="s2">) &lt; number of noise anchors (</span><span class="si">{</span><span class="n">noise_anchors</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

        <span class="c1"># Corr-between range sanity check</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_between</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;corr_between must lie in [-1, 1], got </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_between</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># anchor_class indices must be &lt; n_classes</span>
        <span class="n">max_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_clusters</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="n">cluster</span><span class="o">.</span><span class="n">anchor_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cluster</span><span class="o">.</span><span class="n">anchor_class</span> <span class="o">&gt;</span> <span class="n">max_idx</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;CorrClusterConfig.anchor_class=</span><span class="si">{</span><span class="n">cluster</span><span class="o">.</span><span class="n">anchor_class</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;but only </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span><span class="si">}</span><span class="s2"> classes are defined (max index </span><span class="si">{</span><span class="n">max_idx</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># ------------------------------------------------------ convenience API</span>

<div class="viewcode-block" id="DatasetConfig.from_yaml">
<a class="viewcode-back" href="../../_autosummary/biomedical_data_generator.DatasetConfig.html#biomedical_data_generator.DatasetConfig.from_yaml">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DatasetConfig</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load from YAML and validate via the same pipeline.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>  <span class="c1"># local import to keep core dependencies lean</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">raw_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">raw_config</span><span class="p">)</span></div>


    <span class="c1"># ------------------------------ anchor / proxy accounting ----------------</span>

<div class="viewcode-block" id="DatasetConfig.count_informative_anchors">
<a class="viewcode-back" href="../../_autosummary/biomedical_data_generator.DatasetConfig.html#biomedical_data_generator.DatasetConfig.count_informative_anchors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">count_informative_anchors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count clusters whose anchor contributes as &#39;informative&#39;.</span>

<span class="sd">        Note: This is a subset of n_informative, not a separate count.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The number of clusters with anchor_role == &quot;informative&quot;.</span>

<span class="sd">        Note:</span>
<span class="sd">            If you want the number of *additional* features contributed by clusters,</span>
<span class="sd">            use `self._proxies_from_clusters(self.corr_clusters)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_clusters</span> <span class="ow">or</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">anchor_role</span> <span class="o">==</span> <span class="s2">&quot;informative&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DatasetConfig.count_noise_anchors">
<a class="viewcode-back" href="../../_autosummary/biomedical_data_generator.DatasetConfig.html#biomedical_data_generator.DatasetConfig.count_noise_anchors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">count_noise_anchors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count clusters whose anchor is &#39;noise&#39; (non-informative anchor).</span>

<span class="sd">        Returns:</span>
<span class="sd">            The number of clusters with anchor_role == &quot;noise&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_clusters</span> <span class="ow">or</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">anchor_role</span> <span class="o">==</span> <span class="s2">&quot;noise&quot;</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_proxies_from_clusters</span><span class="p">(</span>
        <span class="n">clusters</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">CorrClusterConfig</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of additional features contributed by all clusters.</span>

<span class="sd">        For a cluster of size k, proxies = max(0, k - 1) regardless of anchor_role.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">clusters</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">n_cluster_features</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_informative_free</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Informative features outside clusters (excludes informative anchors).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_informative</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_informative_anchors</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_noise_free</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Independent noise features (excludes noise anchors).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_noise</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_noise_anchors</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># ------------------------------ derived global counts ---------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total samples (derived from class_configs).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">n_samples</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_configs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of classes (derived from class_configs).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_configs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">n_features</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Total number of features (informative + noise + cluster proxies).&quot;&quot;&quot;</span>
        <span class="n">proxies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxies_from_clusters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_clusters</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_informative</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_noise</span> <span class="o">+</span> <span class="n">proxies</span><span class="p">)</span>

    <span class="c1"># ------------------------------ class-level helpers ----------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">class_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of class labels (auto-generated or user-provided).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">c</span><span class="o">.</span><span class="n">label</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">label</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;class_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_configs</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">class_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Class counts as dict {class_idx: n_samples}.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">n_samples</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">class_configs</span><span class="p">)}</span>

    <span class="c1"># ------------------------------ summary / breakdown ----------------------</span>

<div class="viewcode-block" id="DatasetConfig.breakdown">
<a class="viewcode-back" href="../../_autosummary/biomedical_data_generator.DatasetConfig.html#biomedical_data_generator.DatasetConfig.breakdown">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">breakdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Structured feature counts incl. cluster proxies and anchor split.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dict with keys:</span>
<span class="sd">            - n_informative_total</span>
<span class="sd">            - n_informative_anchors</span>
<span class="sd">            - n_informative_free</span>
<span class="sd">            - n_noise_total</span>
<span class="sd">            - n_noise_anchors</span>
<span class="sd">            - n_noise_free</span>
<span class="sd">            - proxies_from_clusters</span>
<span class="sd">            - n_features</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">proxies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_proxies_from_clusters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_clusters</span><span class="p">)</span>
        <span class="n">n_inf_anchors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_informative_anchors</span><span class="p">()</span>
        <span class="n">n_noise_anchors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_noise_anchors</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;n_informative_total&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_informative</span><span class="p">),</span>
            <span class="s2">&quot;n_informative_anchors&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_inf_anchors</span><span class="p">),</span>
            <span class="s2">&quot;n_informative_free&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_informative</span> <span class="o">-</span> <span class="n">n_inf_anchors</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
            <span class="s2">&quot;n_noise_total&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_noise</span><span class="p">),</span>
            <span class="s2">&quot;n_noise_anchors&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_noise_anchors</span><span class="p">),</span>
            <span class="s2">&quot;n_noise_free&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_noise</span> <span class="o">-</span> <span class="n">n_noise_anchors</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
            <span class="s2">&quot;proxies_from_clusters&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">proxies</span><span class="p">),</span>
            <span class="s2">&quot;n_features&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_features</span><span class="p">),</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="DatasetConfig.summary">
<a class="viewcode-back" href="../../_autosummary/biomedical_data_generator.DatasetConfig.html#biomedical_data_generator.DatasetConfig.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">per_cluster</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">as_markdown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a human-readable summary of the configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            per_cluster: Include one line per cluster (size/role/rho/etc.).</span>
<span class="sd">            as_markdown: Render as a Markdown table-like text.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A formatted string summarizing the feature layout and counts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">breakdown</span><span class="p">()</span>
        <span class="n">lines</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">as_markdown</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;### Feature breakdown&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| key | value |&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|-----|-------|&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;n_informative_total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;n_informative_anchors&quot;</span><span class="p">,</span>
                <span class="s2">&quot;n_informative_free&quot;</span><span class="p">,</span>
                <span class="s2">&quot;n_noise_total&quot;</span><span class="p">,</span>
                <span class="s2">&quot;n_noise_anchors&quot;</span><span class="p">,</span>
                <span class="s2">&quot;n_noise_free&quot;</span><span class="p">,</span>
                <span class="s2">&quot;proxies_from_clusters&quot;</span><span class="p">,</span>
                <span class="s2">&quot;n_features&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2"> |&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Feature breakdown&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- n_informative_total    : </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;n_informative_total&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- n_informative_anchors  : </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;n_informative_anchors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- n_informative_free     : </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;n_informative_free&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- n_noise_total          : </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;n_noise_total&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- n_noise_anchors        : </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;n_noise_anchors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- n_noise_free           : </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;n_noise_free&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- proxies_from_clusters  : </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;proxies_from_clusters&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- n_features             : </span><span class="si">{</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;n_features&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">per_cluster</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_clusters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">as_markdown</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;### Clusters&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;| id | size | role | rho | structure | label | proxies |&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;|----|------|------|-----|-----------|-------|---------|&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Clusters:&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_clusters</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">proxies</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">n_cluster_features</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">label</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">as_markdown</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;| </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">n_cluster_features</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">anchor_role</span><span class="si">}</span><span class="s2"> | &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">rho</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">structure</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">proxies</span><span class="si">}</span><span class="s2"> |&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;- #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: n_cluster_features=</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">n_cluster_features</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;role=</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">anchor_role</span><span class="si">}</span><span class="s2">, rho=</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">rho</span><span class="si">}</span><span class="s2">, structure=</span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">structure</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;label=</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">, proxies=</span><span class="si">{</span><span class="n">proxies</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Sigrun May.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>